{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import {Controller} from \"stimulus\"\nclass MultiSelectController extends Controller {\n    static targets = [\"select\", \"input\", \"results\", \"activeItems\", \"field\"]\n    static classes = [\"result\", \"resultSelected\", \"itemActive\"]\n\n    static values = {\n        selectedIndex: Number,\n        isShowing: Boolean,\n        allowDuplicates: Boolean,\n        allowCreatingNewEntries: Boolean,\n        maxResults: Number\n    }\n\n    connect() {\n        this.selectedIndexValue = -1\n        this.maxResultsValue = this.maxResultsValue || 10\n\n        this.selectTarget.classList.add(\"hidden\")\n        this.resultsTarget.tabIndex = 0\n\n        this.inputTarget.setAttribute(\"autocomplete\", \"off\")\n        this.inputTarget.setAttribute(\"spellcheck\", \"false\")\n\n        this.inputTarget.addEventListener('keydown', (e) => this.handleKey(e))\n        this.resultsTarget.addEventListener('keydown', (e) => this.handleKey(e))\n        this.inputTarget.addEventListener('input', (e) => this.handleInputChange(e))\n        this.resultsTarget.addEventListener('click', (e) => this.resultsClick(e))\n\n        this.options.filter(o => o.selected).forEach(o => this.selectItem(o, true))\n    }\n\n    get options() {\n        return Array.apply(null, this.selectTarget.options).filter(o => o.value)\n    }\n\n    get resultsItemCount() {\n        return this.resultsTarget.querySelectorAll(\"li\").length\n    }\n\n    get filteredResults() {\n        const results = this.filterResults(this.inputTarget.value)\n        return results\n    }\n\n    handleKey(e) {\n        switch (e.key) {\n            case \"Escape\":\n                this.isShowingValue = false\n                this.selectedIndexValue = -1\n                break\n\n            case \"ArrowDown\": \n                e.preventDefault()\n                if (this.isShowingValue) {\n                    if (this.selectedIndexValue < this.resultsItemCount - 1) {\n                        this.selectedIndexValue++\n                    }\n                } else {\n                    this.showResults(this.filteredResults)\n                    this.selectedIndexValue = 0\n                }\n\n                break\n\n            case \"ArrowUp\": \n                if (this.isShowingValue && this.selectedIndexValue > 0) {\n                    e.preventDefault()\n                    this.selectedIndexValue--\n                }\n                break\n\n            case \"Enter\":\n                e.preventDefault()\n                if (this.selectedIndexValue > -1 && this.selectedIndexValue < this.resultsItemCount) {\n                    const item = this.filteredResults[this.selectedIndexValue]\n                    this.selectItem(item)\n                } else if (this.allowCreatingNewEntriesValue) {\n                    let trimmedInput = this.inputTarget.value.trim()\n                    if (trimmedInput.length && !this.findOption(trimmedInput)) {\n                        this.createNewEntry(trimmedInput)\n                    }\n                }\n                break\n        }\n    }\n\n    selectItem(item, force) {\n        if (!this.allowDuplicatesValue && item.selected && !force) {\n            return\n        }\n\n        let itemTag = this.createSelectedItemTag(item)\n        this.activeItemsTarget.appendChild(itemTag)\n        item.selected = true\n        this.selectedIndex = -1\n        this.isShowingValue = false\n        this.inputTarget.value = \"\"\n    }\n\n    createNewEntry(text) {\n        let opt = new Option(text, text)\n        this.selectTarget.add(opt, null)\n        this.selectItem(opt)\n    }\n\n    createSelectedItemTag(item) {\n        let template = this.activeItemsTarget.querySelector(\"template\")\n        if (template) {\n            let itemSpan = template.content.cloneNode(true).children[0]\n            itemSpan.querySelector(\"span\").innerText = item.text\n            itemSpan.querySelector(\"button\").addEventListener(\"click\", (e) => {\n                item.selected = false\n                this.activeItemsTarget.removeChild(itemSpan)\n            })\n            return itemSpan\n        } else {\n            let itemSpan = document.createElement(\"span\")\n            const itemActiveClass = this.hasItemActiveClass ? this.itemActiveClass : \"multi-select-item--active\"\n            itemSpan.classList.add(...(itemActiveClass.split(/\\s+/)))\n\n            let itemText = document.createElement(\"span\")\n            itemText.innerText = item.text\n            itemSpan.appendChild(itemText)\n\n            let removeButton = document.createElement(\"span\")\n            removeButton.innerText = \"x\"\n            removeButton.classList.add(\"multi-select-item-remove\")\n            removeButton.addEventListener(\"click\", (e) => {\n                item.selected = false\n                this.activeItemsTarget.removeChild(itemSpan)\n            })\n            itemSpan.appendChild(removeButton)\n\n            return itemSpan\n        }\n    }\n\n    handleInputChange(e) {\n        this.selectedIndexValue = -1\n        this.showResults(this.filteredResults)\n    }\n\n    findOption(value) {\n        return this.options.filter(o => o.value == value)[0]\n    }\n\n    resultsClick(e) {\n        const selectedListItem = e.target.closest('[role=\"option\"]')\n        const option = this.findOption(selectedListItem.dataset.value)\n        if (option) {\n            this.selectItem(option)\n        } else if (selectedListItem.dataset && selectedListItem.dataset.loadMore) {\n            // load more\n            const maxResults = selectedListItem.dataset.index;\n            this.showResults(this.filteredResults, maxResults);\n        } else {\n            console.warn(\"Couldn't find option with value: \", selectedListItem.dataset.value)\n        }\n    }\n\n    filterResults(term) {\n        let opts = this.options\n        if (!this.allowDuplicatesValue) {\n            opts = opts.filter(o => !o.selected)\n        }\n\n        if (term === \"\") {\n            return opts\n        }\n\n        let normalize = (s) => {\n            return s.toLowerCase()\n                .replace(/['\"]/, \"\")\n        }\n\n        return opts.filter(o => {\n            return normalize(o.text).indexOf(normalize(term)) > -1\n        })\n    }\n\n    showResults(results, max = null) {\n        if (max === null) {\n            max = this.maxResultsValue;\n        }\n\n        this.removeChildren(this.resultsTarget)\n        let index = 0\n        let resultItems = results.map(r => this.createResultItem(r.text, r.value, index++))\n        if (resultItems.length > 0) {\n            this.isShowingValue = true\n            resultItems.slice(0, max).forEach(item => this.resultsTarget.appendChild(item))\n            if (resultItems.length > max) {\n                this.resultsTarget.appendChild(this.createLoadMoreItem(max + this.maxResultsValue))\n            }\n        }\n    }\n\n    createLoadMoreItem(index) {\n        let li = this.createResultItem(\"Moreâ€¦\", null, index)\n        li.dataset.loadMore = true\n        return li\n    }\n\n    createResultItem(result, value, index) {\n        let li = document.createElement(\"li\")\n        li.role = \"option\"\n        if (value) {\n            li.dataset.value = value\n        }\n        li.innerText = result\n        li.dataset.index = index\n        const resultClass = this.hasResultClass ? this.resultClass : \"multi-select-result\"\n        li.classList.add(...(resultClass.split(/\\s+/)))\n        return li\n    }\n    \n    removeChildren(el) {\n        while (el.firstChild) {\n            el.removeChild(el.firstChild)\n        }\n    }\n\n    isShowingValueChanged() {\n        if (this.isShowingValue) {\n            this.resultsTarget.setAttribute(\"aria-expanded\", \"true\")\n            this.resultsTarget.classList.remove(\"hidden\")\n        } else {\n            this.resultsTarget.setAttribute(\"aria-expanded\", \"true\")\n            this.resultsTarget.classList.add(\"hidden\")\n        }\n    }\n\n    selectedIndexValueChanged() {\n        let lis = this.resultsTarget.querySelectorAll(\"li\")\n        const resultSelectedClass = (this.hasResultSelectedClass ? this.resultSelectedClass : \"multi-select-result--selected\").split(/\\s+/)\n        lis.forEach(li => li.classList.remove(...resultSelectedClass))\n        if (this.selectedIndexValue >= 0 && this.selectedIndexValue < lis.length) {\n            lis[this.selectedIndexValue].classList.add(...resultSelectedClass)\n        } else if (this.selectedIndexValue > 0) {\n            // stay at last element\n            this.selectedIndexValue = lis.length - 1\n        }\n    }\n}\n\nexport default MultiSelectController"],"names":["MultiSelectController","Controller","connect","this","selectedIndexValue","maxResultsValue","selectTarget","classList","add","resultsTarget","tabIndex","inputTarget","setAttribute","addEventListener","e","handleKey","handleInputChange","resultsClick","options","filter","o","selected","forEach","selectItem","Array","apply","value","resultsItemCount","querySelectorAll","length","filteredResults","filterResults","key","isShowingValue","preventDefault","showResults","allowCreatingNewEntriesValue","trimmedInput","trim","findOption","createNewEntry","item","force","allowDuplicatesValue","itemTag","createSelectedItemTag","activeItemsTarget","appendChild","selectedIndex","text","opt","Option","template","querySelector","itemSpan","content","cloneNode","children","innerText","removeChild","document","createElement","hasItemActiveClass","itemActiveClass","split","itemText","removeButton","selectedListItem","target","closest","option","dataset","loadMore","index","console","warn","term","opts","normalize","s","toLowerCase","replace","indexOf","results","max","removeChildren","resultItems","map","r","createResultItem","slice","createLoadMoreItem","li","result","role","hasResultClass","resultClass","el","firstChild","isShowingValueChanged","remove","selectedIndexValueChanged","lis","resultSelectedClass","hasResultSelectedClass","targets","classes","values","Number","isShowing","Boolean","allowDuplicates","allowCreatingNewEntries","maxResults"],"mappings":"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"}